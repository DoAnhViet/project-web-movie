@model WebMovie.Models.MovieDetailResponse
@{
    ViewData["Title"] = Model?.Movie?.Name ?? "Xem phim";
}

<style>
    .player-container {
        background: #000;
        margin: 0 0 20px 0;
        width: 100%;
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }
    .player-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .episode-item {
        display: inline-block;
        padding: 8px 15px;
        margin: 5px;
        background: #3d3d3d;
        color: #fff;
        border-radius: 5px;
        text-decoration: none;
    }
    .episode-item:hover, .episode-item.active {
        background: #ff6b35;
        color: #fff;
    }
</style>

<div class="container-fluid mt-3">
    @if (Model != null && Model.Movie != null)
    {
        var movie = Model.Movie;
        var firstEpisode = Model.Episodes?.FirstOrDefault()?.ServerDataList?.FirstOrDefault();
        
        <div class="row">
            <div class="col-12">
                <div class="player-container">
                    @if (firstEpisode != null && !string.IsNullOrEmpty(firstEpisode.LinkEmbed))
                    {
                        <iframe id="iframe-player"
                                src="@firstEpisode.LinkEmbed"
                                frameborder="0"
                                allowfullscreen
                                allow="autoplay; encrypted-media">
                        </iframe>
                    }
                    else
                    {
                        <div class="alert alert-warning m-3">
                            <i class="fas fa-exclamation-triangle"></i> Không tìm thấy link xem phim
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h2>@movie.Name</h2>
                <p class="text-muted">@movie.OriginName</p>
                
                <div class="movie-meta">
                    @if (!string.IsNullOrEmpty(movie.Quality))
                    {
                        <span class="quality">@movie.Quality</span>
                    }
                    @if (!string.IsNullOrEmpty(movie.EpisodeCurrent))
                    {
                        <span class="episode">@movie.EpisodeCurrent</span>
                    }
                    @if (movie.Year > 0)
                    {
                        <span class="year">@movie.Year</span>
                    }
                </div>

                <div class="movie-description mt-3">
                    <h3>Nội dung phim</h3>
                    <p class="content">@Html.Raw(movie.Content)</p>
                    
                    @if (movie.Actor != null && movie.Actor.Any())
                    {
                        <p><strong>Diễn viên:</strong> @string.Join(", ", movie.Actor)</p>
                    }
                    
                    @if (movie.Director != null && movie.Director.Any())
                    {
                        <p><strong>Đạo diễn:</strong> @string.Join(", ", movie.Director)</p>
                    }
                    
                    @if (movie.Category != null && movie.Category.Any())
                    {
                        <p><strong>Thể loại:</strong> @string.Join(", ", movie.Category.Select(c => c.Name))</p>
                    }
                    
                    @if (movie.Country != null && movie.Country.Any())
                    {
                        <p><strong>Quốc gia:</strong> @string.Join(", ", movie.Country.Select(c => c.Name))</p>
                    }
                </div>

                @if (Model.Episodes != null && Model.Episodes.Any())
                {
                    <div class="mt-4">
                        <h3>Danh sách tập phim</h3>
                        @foreach (var server in Model.Episodes)
                        {
                            <div class="mb-3">
                                <h5>@server.ServerName</h5>
                                <div>
                                    @foreach (var episode in server.ServerDataList)
                                    {
                                        <a href="#" 
                                           class="episode-item" 
                                           data-embed="@episode.LinkEmbed"
                                           data-slug="@episode.Slug"
                                           onclick="changeEpisode(this); return false;">
                                            @episode.Name
                                        </a>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> Không tìm thấy thông tin phim. 
            <a href="/Movie/NewMovies" class="alert-link">Quay lại danh sách phim</a>
        </div>
    }

    <!-- COMMENT SECTION -->
    @inject WebMovie.Services.CommentService CommentService
    @{
        var movieSlug = Context.Request.Query["slug"].ToString();
        var comments = await CommentService.GetCommentsByMovieAsync(movieSlug);
        var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    }

    <div class="row mt-5">
        <div class="col-12">
            <div class="comment-section" style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 10px;">
                <h4 style="color: #fff; margin-bottom: 20px;">
                    <i class="fas fa-comments"></i> Bình luận (@comments.Count)
                </h4>

                @if (User.Identity?.IsAuthenticated == true)
                {
                    <!-- Form thêm comment -->
                    <div class="add-comment-form" style="margin-bottom: 30px;">
                        @Html.AntiForgeryToken()
                        <textarea id="comment-content" 
                                  class="form-control" 
                                  rows="3" 
                                  placeholder="Viết bình luận của bạn..."
                                  maxlength="1000"
                                  style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #555; resize: vertical;"></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                                <span id="char-count">0</span>/1000 ký tự
                            </small>
                            <button id="btn-submit-comment" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Gửi bình luận
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <a href="/Account/Login?returnUrl=@Context.Request.Path@Context.Request.QueryString">Đăng nhập</a> để bình luận
                    </div>
                }

                <!-- Danh sách comment -->
                <div id="comments-list">
                    @if (comments.Any())
                    {
                        foreach (var comment in comments)
                        {
                            var isOwner = comment.UserId == currentUserId;
                            var isAdmin = User.IsInRole("Admin");
                            
                            <div class="comment-item" data-comment-id="@comment.Id" style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #ff6b35;">
                                <div class="comment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: #ff6b35;">@(comment.User?.FullName ?? comment.User?.Email ?? "Anonymous")</strong>
                                        @if (User.IsInRole("Admin") && comment.User?.Email == "admin@webmovie.com")
                                        {
                                            <span class="badge bg-danger ms-2">Admin</span>
                                        }
                                        <small class="text-muted ms-2">
                                            @comment.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                            @if (comment.UpdatedAt != null)
                                            {
                                                <span>(đã chỉnh sửa)</span>
                                            }
                                        </small>
                                    </div>
                                    @if (isOwner || isAdmin)
                                    {
                                        <div class="comment-actions">
                                            @if (isOwner)
                                            {
                                                <button class="btn btn-sm btn-outline-secondary btn-edit-comment" title="Sửa">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            }
                                            <button class="btn btn-sm btn-outline-danger btn-delete-comment" title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                                <div class="comment-content" style="color: #ddd;">
                                    @comment.Content
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center">Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var currentEpisodeSlug = '@(Model?.Episodes?.FirstOrDefault()?.ServerDataList?.FirstOrDefault()?.Slug ?? "")';
        var movieSlug = '@(Model?.Movie?.Slug ?? "")';
        var movieTitle = '@(Model?.Movie?.Name ?? "")';
        var posterUrl = '@(Model?.Movie?.PosterUrl ?? "")';
        var currentEpisodeName = '@(Model?.Episodes?.FirstOrDefault()?.ServerDataList?.FirstOrDefault()?.Name ?? "Tập 1")';
        var saveProgressInterval;
        var isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");

        function changeEpisode(element) {
            var embedUrl = element.getAttribute('data-embed');
            var episodeSlug = element.getAttribute('data-slug') || '';
            var episodeName = element.textContent.trim();
            
            if (embedUrl) {
                document.getElementById('iframe-player').src = embedUrl;
                
                // Remove active class from all episodes
                document.querySelectorAll('.episode-item').forEach(function(item) {
                    item.classList.remove('active');
                });
                
                // Add active class to clicked episode
                element.classList.add('active');
                
                // Update current episode info
                currentEpisodeSlug = episodeSlug;
                currentEpisodeName = episodeName;
                
                // Reset progress tracking for new episode
                if (isAuthenticated) {
                    loadWatchProgress();
                }
            }
        }

        // Lấy tiến trình xem đã lưu
        function loadWatchProgress() {
            if (!isAuthenticated || !movieSlug || !currentEpisodeSlug) return;
            
            fetch(`/Watch/GetWatchProgress?movieSlug=${movieSlug}&episodeSlug=${currentEpisodeSlug}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.currentTime > 0) {
                        console.log(`Đã tìm thấy tiến trình: ${data.currentTime}s (${data.progressPercent}%)`);
                        // Hiển thị thông báo hoặc tự động seek đến vị trí đã xem
                        showResumeNotification(data.currentTime);
                    }
                })
                .catch(error => console.error('Error loading progress:', error));
        }

        // Hiển thị thông báo tiếp tục xem
        function showResumeNotification(currentTime) {
            var minutes = Math.floor(currentTime / 60);
            var seconds = currentTime % 60;
            var timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            var notification = `
                <div class="alert alert-info alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
                    <strong><i class="fas fa-play-circle"></i> Tiếp tục xem?</strong>
                    <p class="mb-2">Bạn đã xem đến ${timeStr}. Bạn có muốn tiếp tục?</p>
                    <button type="button" class="btn btn-sm btn-primary" onclick="this.parentElement.remove();">
                        <i class="fas fa-check"></i> OK
                    </button>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notification);
            
            // Auto dismiss after 10 seconds
            setTimeout(() => {
                var alerts = document.querySelectorAll('.alert-info');
                alerts.forEach(alert => alert.remove());
            }, 10000);
        }

        // Lưu tiến trình xem
        function saveWatchProgress(currentTime, totalTime) {
            if (!isAuthenticated || !movieSlug || !currentEpisodeSlug) return;
            
            var data = {
                movieSlug: movieSlug,
                movieTitle: movieTitle,
                posterUrl: posterUrl,
                episodeName: currentEpisodeName,
                episodeSlug: currentEpisodeSlug,
                currentTime: Math.floor(currentTime),
                totalTime: Math.floor(totalTime)
            };
            
            fetch('/Watch/SaveWatchProgress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Đã lưu tiến trình xem:', Math.floor(currentTime), 'giây');
                }
            })
            .catch(error => console.error('Error saving progress:', error));
        }

        // Lắng nghe sự kiện từ iframe (nếu player hỗ trợ)
        // Vì iframe embed nên không thể trực tiếp track, nhưng có thể save định kỳ
        if (isAuthenticated) {
            // Load progress khi vào trang
            loadWatchProgress();
            
            // Lưu tiến trình mỗi 30 giây (giả định user đang xem)
            var watchTime = 0;
            @if (ViewBag.WatchHistory != null)
            {
                <text>watchTime = @ViewBag.WatchHistory.CurrentTime;</text>
            }
            
            saveProgressInterval = setInterval(function() {
                watchTime += 30; // Tăng 30 giây
                var estimatedTotal = watchTime + 600; // Giả định còn 10 phút
                saveWatchProgress(watchTime, estimatedTotal);
            }, 30000); // Mỗi 30 giây
        }

        // Cleanup khi thoát trang
        window.addEventListener('beforeunload', function() {
            if (saveProgressInterval) {
                clearInterval(saveProgressInterval);
            }
        });

        // =============== COMMENT FUNCTIONALITY ===============
        // Đếm ký tự
        const commentTextarea = document.getElementById('comment-content');
        const charCountSpan = document.getElementById('char-count');
        
        if (commentTextarea) {
            commentTextarea.addEventListener('input', function() {
                charCountSpan.textContent = this.value.length;
            });
        }

        // Gửi comment
        const btnSubmitComment = document.getElementById('btn-submit-comment');
        if (btnSubmitComment) {
            btnSubmitComment.addEventListener('click', function() {
                const content = commentTextarea.value.trim();
                
                if (!content) {
                    alert('Vui lòng nhập nội dung bình luận');
                    return;
                }

                const formData = new FormData();
                formData.append('movieSlug', movieSlug);
                formData.append('movieTitle', movieTitle);
                formData.append('content', content);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                btnSubmitComment.disabled = true;
                btnSubmitComment.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...';

                fetch('/Comment/Add', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload(); // Reload để hiện comment mới
                    } else {
                        alert(data.message);
                    }
                })
                .catch(err => {
                    alert('Có lỗi xảy ra, vui lòng thử lại');
                    console.error(err);
                })
                .finally(() => {
                    btnSubmitComment.disabled = false;
                    btnSubmitComment.innerHTML = '<i class="fas fa-paper-plane"></i> Gửi bình luận';
                });
            });
        }

        // Xóa comment
        document.querySelectorAll('.btn-delete-comment').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!confirm('Bạn có chắc muốn xóa comment này?')) return;

                const commentItem = this.closest('.comment-item');
                const commentId = commentItem.dataset.commentId;

                const formData = new FormData();
                formData.append('commentId', commentId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                fetch('/Comment/Delete', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        commentItem.remove();
                        alert(data.message);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(err => {
                    alert('Có lỗi xảy ra');
                    console.error(err);
                });
            });
        });

        // Sửa comment (simple version - prompt)
        document.querySelectorAll('.btn-edit-comment').forEach(btn => {
            btn.addEventListener('click', function() {
                const commentItem = this.closest('.comment-item');
                const commentId = commentItem.dataset.commentId;
                const currentContent = commentItem.querySelector('.comment-content').textContent.trim();
                
                const newContent = prompt('Sửa nội dung comment:', currentContent);
                if (!newContent || newContent === currentContent) return;

                const formData = new FormData();
                formData.append('commentId', commentId);
                formData.append('content', newContent);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                fetch('/Comment/Update', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        commentItem.querySelector('.comment-content').textContent = data.newContent;
                        alert(data.message);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(err => {
                    alert('Có lỗi xảy ra');
                    console.error(err);
                });
            });
        });
    </script>
}
