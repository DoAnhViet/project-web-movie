@model WebMovie.Models.MovieDetailResponse
@{
    ViewData["Title"] = Model?.Movie?.Name ?? "Xem phim";
    ViewData["HideSearchBar"] = true; // Ẩn SearchBar để tránh conflict với form comment
}

<style>
    .player-container {
        background: #000;
        margin: 0 0 20px 0;
        width: 100%;
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }
    .player-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .episode-item {
        display: inline-block;
        padding: 8px 15px;
        margin: 5px;
        background: #3d3d3d;
        color: #fff;
        border-radius: 5px;
        text-decoration: none;
    }
    .episode-item:hover, .episode-item.active {
        background: #ff6b35;
        color: #fff;
    }
</style>

<div class="container-fluid mt-3">
    @if (Model != null && Model.Movie != null)
    {
        var movie = Model.Movie;
        var firstEpisode = Model.Episodes?.FirstOrDefault()?.ServerDataList?.FirstOrDefault();
        
        <div class="row">
            <div class="col-12">
                <div class="player-container">
                    @if (firstEpisode != null && !string.IsNullOrEmpty(firstEpisode.LinkEmbed))
                    {
                        <iframe id="iframe-player"
                                src="@firstEpisode.LinkEmbed"
                                frameborder="0"
                                allowfullscreen
                                allow="autoplay; encrypted-media">
                        </iframe>
                    }
                    else
                    {
                        <div class="alert alert-warning m-3">
                            <i class="fas fa-exclamation-triangle"></i> Không tìm thấy link xem phim
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h2>@movie.Name</h2>
                <p class="text-muted">@movie.OriginName</p>
                
                <div class="movie-meta">
                    @if (!string.IsNullOrEmpty(movie.Quality))
                    {
                        <span class="quality">@movie.Quality</span>
                    }
                    @if (!string.IsNullOrEmpty(movie.EpisodeCurrent))
                    {
                        <span class="episode">@movie.EpisodeCurrent</span>
                    }
                    @if (movie.Year > 0)
                    {
                        <span class="year">@movie.Year</span>
                    }
                </div>

                <div class="movie-description mt-3">
                    <h3>Nội dung phim</h3>
                    <p class="content">@Html.Raw(movie.Content)</p>
                    
                    @if (movie.Actor != null && movie.Actor.Any())
                    {
<p><strong>Diễn viên:</strong> @string.Join(", ", movie.Actor)</p>
                    }
                    
                    @if (movie.Director != null && movie.Director.Any())
                    {
                        <p><strong>Đạo diễn:</strong> @string.Join(", ", movie.Director)</p>
                    }
                    
                    @if (movie.Category != null && movie.Category.Any())
                    {
                        <p><strong>Thể loại:</strong> @string.Join(", ", movie.Category.Select(c => c.Name))</p>
                    }
                    
                    @if (movie.Country != null && movie.Country.Any())
                    {
                        <p><strong>Quốc gia:</strong> @string.Join(", ", movie.Country.Select(c => c.Name))</p>
                    }
                </div>

                @if (Model.Episodes != null && Model.Episodes.Any())
                {
                    <div class="mt-4">
                        <h3>Danh sách tập phim</h3>
                        @foreach (var server in Model.Episodes)
                        {
                            <div class="mb-3">
                                <h5>@server.ServerName</h5>
                                <div>
                                    @foreach (var episode in server.ServerDataList)
                                    {
                                        <a href="#" 
                                           class="episode-item" 
                                           data-embed="@episode.LinkEmbed"
                                           data-slug="@episode.Slug"
                                           onclick="changeEpisode(this); return false;">
                                            @episode.Name
                                        </a>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }

                <!-- Comment Section -->
                <div class="comment-section mt-5">
                    <h3 class="mb-4">
                        <i class="fas fa-comments me-2"></i>
                        Bình luận phim
                    </h3>

                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="comment-form-card mb-4">
                            <div class="d-flex align-items-start">
                                <div class="user-avatar me-3">
                                    <i class="fas fa-user-circle fa-2x text-primary-custom"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <form id="comment-form" onsubmit="return false;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="movieSlug" value="@Model.Movie.Slug" />
                                        <input type="hidden" name="movieTitle" value="@Model.Movie.Name" />
                                        <textarea 
                                            id="comment-content" 
                                            name="content" 
                                            class="form-control comment-textarea" 
                                            rows="3" 
                                            placeholder="Viết bình luận của bạn về bộ phim này..."
                                            maxlength="1000"></textarea>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <small id="char-count">0/1000 ký tự</small>
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="fas fa-paper-plane me-1"></i>
                                                Gửi bình luận
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <a href="/Account/Login?returnUrl=@Context.Request.Path@Context.Request.QueryString">Đăng nhập</a> để bình luận về bộ phim này
                        </div>
                    }

                    <!-- Comments List -->
                    <div id="comments-list">
                        <!-- Comments will be loaded here via AJAX -->
                        <div class="text-center py-4 comment-loading">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> Không tìm thấy thông tin phim. 
            <a href="/Movie/NewMovies" class="alert-link">Quay lại danh sách phim</a>
        </div>
    }
</div>

<style>
    .comment-section {
        background: #1a1a1a;
        padding: 35px;
        border-radius: 12px;
        border: 1px solid #2a2a2a;
    }
    .comment-section h3 {
        color: #fff;
        font-weight: 700;
        margin-bottom: 25px;
    }
    .comment-form-card {
        background: #2a2a2a;
        padding: 25px;
        border-radius: 10px;
        border: 1px solid #3a3a3a;
    }
    .comment-textarea {
        background: #1a1a1a;
        border: 2px solid #3a3a3a;
        border-radius: 8px;
        transition: all 0.3s ease;
        color: #fff;
    }
    .comment-textarea:focus {
        background: #1a1a1a;
        border-color: #ff6b35;
        box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        color: #fff;
    }
    .comment-textarea::placeholder {
        color: #888;
    }
    .comment-item {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #3a3a3a;
        transition: all 0.3s ease;
    }
    .comment-item:hover {
        border-color: #4a4a4a;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .comment-author {
        font-weight: 600;
        color: #fff;
        font-size: 1rem;
    }
    .comment-date {
        font-size: 0.875rem;
        color: #888;
    }
    .comment-content {
        color: #d1d1d1;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.95rem;
    }
    .comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

    .comment-actions {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #3a3a3a;
    }
    .btn-delete-comment {
        background: transparent;
        color: #ff6b6b;
        font-size: 0.875rem;
        padding: 4px 12px;
        border: 1px solid #ff6b6b;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    .btn-delete-comment:hover {
        background: #ff6b6b;
        color: white;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .text-primary-custom {
        color: #ff6b35 !important;
    }
    #char-count {
        color: #888;
    }
    .alert-info {
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        color: #d1d1d1;
    }
    .alert-info a {
        color: #ff6b35;
        font-weight: 600;
    }
    .alert-info a:hover {
        color: #ff8555;
    }
    .comment-loading {
        color: #888;
    }
    .comment-empty {
        color: #888;
        text-align: center;
        padding: 40px 20px;
    }
    .comment-empty i {
        color: #555;
        font-size: 3rem;
        margin-bottom: 15px;
        display: block;
    }
</style>

@section Scripts {
    <script>
        var currentEpisodeSlug = '@(Model?.Episodes?.FirstOrDefault()?.ServerDataList?.FirstOrDefault()?.Slug ?? "")';
        var movieSlug = '@(Model?.Movie?.Slug ?? "")';
        var movieTitle = '@(Model?.Movie?.Name ?? "")';
        var posterUrl = '@(Model?.Movie?.PosterUrl ?? "")';
        var currentEpisodeName = '@(Model?.Episodes?.FirstOrDefault()?.ServerDataList?.FirstOrDefault()?.Name ?? "Tập 1")';
        var saveProgressInterval;
        var watchTime = 0;
        var antiForgeryToken = '';
        var isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");

        if (!currentEpisodeSlug) {
            currentEpisodeSlug = movieSlug || 'default';
        }

        function changeEpisode(element) {
var embedUrl = element.getAttribute('data-embed');
            var episodeSlug = element.getAttribute('data-slug') || '';
            var episodeName = element.textContent.trim();
            
            if (embedUrl) {
                document.getElementById('iframe-player').src = embedUrl;

                // Update current episode info & highlight
                currentEpisodeSlug = episodeSlug || currentEpisodeSlug || (movieSlug || 'default');
                currentEpisodeName = episodeName || currentEpisodeName;
                setActiveEpisode(currentEpisodeSlug);
                watchTime = 0;
                
                // Reset progress tracking for new episode
                if (isAuthenticated) {
                    loadWatchProgress();
                    // Save an initial history entry immediately when user clicks to watch
                    try {
                        // save 0s as current time; totalTime unknown so pass 0
                        saveWatchProgress(0, 0);
                    } catch (e) {
                        console.error('Error saving initial watch progress:', e);
                    }
                }
            }
        }

        function setActiveEpisode(episodeSlug) {
            if (!episodeSlug) return;

            var normalized = episodeSlug.toString();
            document.querySelectorAll('.episode-item').forEach(function(item) {
                var itemSlug = item.getAttribute('data-slug') || '';
                if (itemSlug === normalized) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Lấy tiến trình xem đã lưu
        function loadWatchProgress() {
            if (!isAuthenticated || !movieSlug) return;

            fetch(`/Watch/GetWatchProgress?movieSlug=${encodeURIComponent(movieSlug)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.currentTime > 0) {
                        if (data.episodeSlug) {
                            currentEpisodeSlug = data.episodeSlug;
                            setActiveEpisode(currentEpisodeSlug);
                        }
                        if (data.episodeName) {
                            currentEpisodeName = data.episodeName;
                        }
                        watchTime = data.currentTime;
                        console.log(`Đã tìm thấy tiến trình: ${data.currentTime}s (${data.progressPercent}%)`);
                        // Hiển thị thông báo hoặc tự động seek đến vị trí đã xem
                        showResumeNotification(data.currentTime);
                    }
                })
                .catch(error => console.error('Error loading progress:', error));
        }

        // Hiển thị thông báo tiếp tục xem
        function showResumeNotification(currentTime) {
            var minutes = Math.floor(currentTime / 60);
            var seconds = currentTime % 60;
            var timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            var notification = `
                <div class="alert alert-info alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
                    <strong><i class="fas fa-play-circle"></i> Tiếp tục xem?</strong>
                    <p class="mb-2">Bạn đã xem đến ${timeStr}. Bạn có muốn tiếp tục?</p>
<button type="button" class="btn btn-sm btn-primary" onclick="this.parentElement.remove();">
                        <i class="fas fa-check"></i> OK
                    </button>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notification);
            
            // Auto dismiss after 10 seconds
            setTimeout(() => {
                var alerts = document.querySelectorAll('.alert-info');
                alerts.forEach(alert => alert.remove());
            }, 10000);
        }

        // Lưu tiến trình xem
        function saveWatchProgress(currentTime, totalTime) {
            if (!isAuthenticated || !movieSlug) return;

            var effectiveEpisodeSlug = currentEpisodeSlug || movieSlug || 'default';
            var effectiveEpisodeName = currentEpisodeName || 'Tập 1';

            var data = {
                movieSlug: movieSlug,
                movieTitle: movieTitle,
                posterUrl: posterUrl,
                episodeName: effectiveEpisodeName,
                episodeSlug: effectiveEpisodeSlug,
                currentTime: Math.floor(currentTime),
                totalTime: Math.floor(totalTime)
            };
            
            fetch('/Watch/SaveWatchProgress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Đã lưu tiến trình xem:', Math.floor(currentTime), 'giây');
                }
            })
            .catch(error => console.error('Error saving progress:', error));
        }

        // Lắng nghe sự kiện từ iframe (nếu player hỗ trợ)
        // Vì iframe embed nên không thể trực tiếp track, nhưng có thể save định kỳ
        if (isAuthenticated) {
            @if (ViewBag.WatchHistory != null)
            {
                <text>watchTime = @ViewBag.WatchHistory.CurrentTime;</text>
                <text>currentEpisodeSlug = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.WatchHistory?.EpisodeSlug ?? string.Empty)) || currentEpisodeSlug;</text>
                <text>currentEpisodeName = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.WatchHistory?.EpisodeName ?? string.Empty)) || currentEpisodeName;</text>
            }

            loadWatchProgress();

            // Tạo bản ghi ban đầu để đảm bảo lịch sử tồn tại
            try {
                var baselineTotal = watchTime > 0 ? watchTime + 600 : 0;
                saveWatchProgress(watchTime || 0, baselineTotal);
            } catch (e) {
                console.error('Error saving initial page watch progress:', e);
            }

            saveProgressInterval = setInterval(function() {
                watchTime += 30; // Tăng 30 giây giả định
                var estimatedTotal = watchTime + 600; // Ước lượng tổng thời gian
                saveWatchProgress(watchTime, estimatedTotal);
            }, 30000); // Mỗi 30 giây
        }

        window.addEventListener('beforeunload', function() {
            if (saveProgressInterval) {
                clearInterval(saveProgressInterval);
            }

            if (isAuthenticated && movieSlug) {
                try {
                    saveWatchProgress(watchTime, watchTime + 600);
                } catch (e) {
                    console.debug('Skip save on unload:', e);
                }
            }
        });

        // ========== COMMENT FUNCTIONS ==========
        
        // Load comments
        function loadComments() {
            fetch(`/Comment/GetComments?movieSlug=${encodeURIComponent(movieSlug)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayComments(data.comments);
                    } else {
                        document.getElementById('comments-list').innerHTML = 
                            '<p class="text-center text-muted">Không thể tải bình luận</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    document.getElementById('comments-list').innerHTML = 
                        '<p class="text-center text-danger">Lỗi khi tải bình luận</p>';
                });
        }

        // Display comments
        function displayComments(comments) {
            var container = document.getElementById('comments-list');
            
            if (!comments || comments.length === 0) {
                container.innerHTML = `
                    <div class="comment-empty">
                        <i class="fas fa-comment-slash"></i>
                        <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
                    </div>
                `;
                return;
            }

            var html = '';
            comments.forEach(comment => {
                var commentDate = new Date(comment.createdAt);
                var timeAgo = getTimeAgo(commentDate);
                var canDelete = Boolean(comment.canDelete);
                var displayName = comment.userDisplayName ? escapeHtml(comment.userDisplayName) : 'Người dùng';
// Xử lý avatar
var avatar = comment.avatarUrl
    ? `<img class="comment-avatar" src="${comment.avatarUrl}" alt="avatar">`
    : `<img class="comment-avatar" 
         src="https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=64&background=e94560&color=ffffff&bold=true"
         alt="avatar">`;

                html += `
                    <div class="comment-item" data-comment-id="${comment.id}">
                        <div class="comment-header">
                            <div class="d-flex align-items-center">
                                  ${avatar}
                             <div class="ms-2">
                                
                                    <div class="comment-author">${displayName}</div>
                                    <div class="comment-date">${timeAgo}</div>
                                </div>
                            </div>
                        </div>
                        <div class="comment-content">${escapeHtml(comment.content || '')}</div>
                        ${canDelete ? `
                            <div class="comment-actions">
                                <button class="btn btn-sm btn-delete-comment" data-comment-id="${comment.id}">
                                    <i class="fas fa-trash me-1"></i>Xóa
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;

            // Attach delete handlers after rendering
            container.querySelectorAll('.btn-delete-comment').forEach(btn => {
                btn.addEventListener('click', function() {
                    var commentId = parseInt(this.getAttribute('data-comment-id'), 10);
                    deleteComment(commentId);
                });
            });
        }

        // Submit comment - Setup event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Character count
            var textarea = document.getElementById('comment-content');
            var charCount = document.getElementById('char-count');
            antiForgeryToken = document.querySelector('#comment-form input[name="__RequestVerificationToken"]')?.value
                || document.querySelector('input[name="__RequestVerificationToken"]')?.value
                || '';

            setActiveEpisode(currentEpisodeSlug);
            
            if (textarea) {
                textarea.addEventListener('input', function() {
                    charCount.textContent = this.value.length + '/1000 ký tự';
                });
            }

            // Submit comment form
            var commentForm = document.getElementById('comment-form');
            if (commentForm) {
                commentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    var content = textarea.value.trim();
                    if (!content) {
                        alert('Vui lòng nhập nội dung bình luận');
                        return;
                    }

                    var formData = new FormData(this);
                    var submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang gửi...';

                    fetch('/Comment/Add', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            textarea.value = '';
                            charCount.textContent = '0/1000 ký tự';
                            loadComments(); // Reload comments
                            
                            // Show success message
                            var alertBox = document.createElement('div');
                            alertBox.className = 'alert alert-success alert-dismissible fade show mt-2';
                            alertBox.innerHTML = `
                                <i class="fas fa-check-circle me-2"></i>${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            commentForm.parentElement.insertBefore(alertBox, commentForm.nextSibling);
                            setTimeout(() => alertBox.remove(), 3000);
                        } else {
                            alert(data.message || 'Có lỗi xảy ra');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi gửi bình luận');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Gửi bình luận';
                    });
                });
            }
        });

        // Delete comment
        function deleteComment(commentId) {
            if (!confirm('Bạn có chắc muốn xóa bình luận này?')) {
                return;
            }

            if (!antiForgeryToken) {
                console.warn('Anti-forgery token is missing; abort delete');
                return;
            }

            var body = `commentId=${encodeURIComponent(commentId)}&__RequestVerificationToken=${encodeURIComponent(antiForgeryToken)}`;

            fetch('/Comment/Delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: body
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadComments(); // Reload comments
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa bình luận');
            });
        }

        // Helper functions
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(date) {
            var now = new Date();
            var seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Vừa xong';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' phút trước';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' giờ trước';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' ngày trước';
            
            return date.toLocaleDateString('vi-VN');
        }

        // Load comments when page loads
        window.addEventListener('load', function() {
            loadComments();
        });

    </script>
}
